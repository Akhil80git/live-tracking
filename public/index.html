<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Location Tracker</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
      background: #ffffff;
    }
    #inhenseBtn {
      padding: 10px 24px;
      font-size: 18px;
      cursor: pointer;
    }
    #inhenseBtn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <button id="inhenseBtn">Inhense</button>

  <script>
    const BACKEND_URL = "/save-location"; // relative path for same domain
    const TWO_MIN = 2 * 60 * 1000;
    const btn = document.getElementById("inhenseBtn");

    let trackingIntervalId = null;
    let trackingStarted = false;

    async function sendLocation() {
      if (!navigator.geolocation) {
        console.log("‚ùå Geolocation supported nahi hai.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const data = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            timestamp: new Date().toISOString(),
          };

          console.log("üì§ Location backend ko bheji gayi:", new Date().toLocaleTimeString());

          try {
            const res = await fetch(BACKEND_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const json = await res.json();
            if (!json.success) console.log("‚ùå Server error while saving location");
          } catch (err) {
            console.log("‚ùå Backend error, saving locally");
            let pending = JSON.parse(localStorage.getItem("pendingLocations") || "[]");
            pending.push(data);
            localStorage.setItem("pendingLocations", JSON.stringify(pending));
          }
        },
        (err) => {
          console.log("‚ùå Error getting location:", err.message);
        },
        { enableHighAccuracy: true }
      );
    }

    async function sendPendingLocations() {
      let pending = JSON.parse(localStorage.getItem("pendingLocations") || "[]");
      if (pending.length === 0) return;

      console.log("üîÅ Pending locations bhejne ki koshish, count:", pending.length);

      for (let loc of pending) {
        try {
          const res = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(loc),
          });
          const json = await res.json();
          if (!json.success) return;
        } catch (err) {
          return;
        }
      }

      localStorage.removeItem("pendingLocations");
      console.log("‚úÖ Saari pending locations send ho gayi.");
    }

    async function startTracking() {
      if (trackingStarted) return;
      trackingStarted = true;

      localStorage.setItem("trackingStarted", "true");

      btn.disabled = true;
      btn.textContent = "Tracking active";

      await sendLocation();
      await sendPendingLocations();

      trackingIntervalId = setInterval(() => {
        sendLocation();
        sendPendingLocations();
      }, TWO_MIN);
    }

    btn.addEventListener("click", () => startTracking());

    window.addEventListener("load", () => {
      const wasStarted = localStorage.getItem("trackingStarted") === "true";
      if (wasStarted) {
        btn.disabled = true;
        btn.textContent = "Tracking active";
        startTracking();
      }
    });

    window.addEventListener("online", () => {
      console.log("üåê Back online:", new Date().toLocaleTimeString());
      sendPendingLocations();
    });
  </script>
</body>
</html>
